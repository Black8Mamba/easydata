# Flash KV 参数存储模块需求规格

## 1. 概述

基于MCU片内Flash的Key-Value参数存储模块，提供持久化参数存储能力。

## 2. 需求列表

### 2.1 平台无关性
- [ ] 通过配置文件适配不同MCU的Flash特性
- [ ] 配置项：Flash块大小（擦除最小单位）
- [ ] 配置项：Flash写入单位
- [ ] 配置项：Flash读取单位
- [ ] 配置项：Flash总空间大小

### 2.2 KV存储格式
- [ ] 固定长度Key-Value存储
- [ ] Key长度可配置（默认32字节）
- [ ] Value长度可配置（默认64字节）
- [ ] 每条记录包含：Key + Value + 元数据（版本号/校验和等）

### 2.3 存储方式
- [ ] 日志式追加写入
- [ ] 新数据追加到Flash末尾
- [ ] 读取时获取最新版本数据

### 2.4 垃圾回收（GC）
- [ ] 被动触发：写入时空间不足自动触发GC
- [ ] 主动触发：提供手动GC接口
- [ ] GC配置：空闲空间低于阈值时触发

### 2.5 可靠性
- [ ] 双备份机制：两份日志（A区/B区）交替使用
- [ ] 断电恢复：上电时检测并恢复到最新数据
- [ ] 数据校验：每条记录包含校验和

### 2.6 数据类型
- [ ] 原始字节存储（用户提供序列化/反序列化逻辑）
- [ ] 提供常用类型转换辅助函数：
  - [ ] int8/uint8/int16/uint16/int32/uint32 转换
  - [ ] float/double 转换
  - [ ] 字符串转换

### 2.7 原子性
- [ ] 支持原子性更新：写入失败时完全回滚
- [ ] 事务机制：新数据写入空闲区 → 验证成功 → 更新索引

### 2.8 空间配置
- [ ] Flash起始地址可配置
- [ ] Flash总大小可配置
- [ ] Key最大长度可配置
- [ ] Value最大长度可配置

## 3. 待确认问题

- [x] 目标MCU具体型号（影响Flash特性适配） - 通用设计，通过配置适配
- [x] 预期存储的参数条目数量（影响空间规划） - 256~512条
- [x] 是否需要支持多实例（多个独立存储区） - 暂时不需要，预留扩展接口

## 4. 讨论记录

### 2025-02-25 初始讨论

**确定的方案：**
- KV格式：固定长度（可配置）
- 存储方式：日志式追加
- GC策略：空间不足被动触发 + 手动触发
- 可靠性：双备份A/B区
- 数据类型：原始字节 + 辅助函数
- 原子性：需要事务支持
- 空间：可配置

**待定：**
- Flash具体空间大小
- 是否需要多实例支持
